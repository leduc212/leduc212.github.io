(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(r){if(r.ep)return;r.ep=!0;const l=t(r);fetch(r.href,l)}})();const D={story:{lives:0,bombRatio:.16,minStartClues:14,targetStartGivens:40,maxAdjStart:2,spreadRows:!0,spreadBlocks:!0,hintRows:5,hintCols:5,logicEnforcement:"hybrid",maxResidualUnknownCells:0,clusterize:!0,minClusters:6,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:2,clueGivenRatio:.75},normal:{lives:0,bombRatio:.18,minStartClues:12,targetStartGivens:36,maxAdjStart:3,spreadRows:!0,spreadBlocks:!0,hintRows:4,hintCols:4,logicEnforcement:"hybrid",maxResidualUnknownCells:2,clusterize:!0,minClusters:5,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:1,clueGivenRatio:.5},hard:{lives:0,bombRatio:.22,minStartClues:10,targetStartGivens:32,maxAdjStart:4,spreadRows:!0,spreadBlocks:!0,hintRows:3,hintCols:3,logicEnforcement:"hybrid",maxResidualUnknownCells:4,clusterize:!0,minClusters:4,clusterSizeMin:2,clusterSizeMax:4,supportPasses:2,bootstrapSteps:1,clueGivenRatio:.5},custom:{lives:0,bombRatio:.14,minStartClues:9,targetStartGivens:36,maxAdjStart:2,spreadRows:!0,spreadBlocks:!0,hintRows:3,hintCols:3,logicEnforcement:"hybrid",maxResidualUnknownCells:2,clusterize:!0,minClusters:5,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:1,clueGivenRatio:2/3}},n=9,J=3,ie="runic-custom-config-v2";function re(){try{const o=localStorage.getItem(ie);return o?JSON.parse(o):null}catch(o){return console.error("Failed to load custom config:",o),null}}function se(o){try{return localStorage.setItem(ie,JSON.stringify(o)),!0}catch(e){return console.error("Failed to save custom config:",e),!1}}function ae(){return localStorage.getItem("runic-theme")||"dark"}function ce(o){localStorage.setItem("runic-theme",o)}let q=1,ne=null;function de(o){let e=2166136261;for(let t=0;t<o.length;t++)e^=o.charCodeAt(t),e=Math.imul(e,16777619);return e>>>0||1}function he(o){ne=String(o),q=de(ne)}function Q(){let o=q;return o^=o<<13,o^=o>>>17,o^=o<<5,q=o>>>0,q/4294967296}function _(o){for(let e=o.length-1;e>0;e--){const t=Math.floor(Q()*(e+1));[o[e],o[t]]=[o[t],o[e]]}return o}function ue(){return{solution:Array.from({length:n},()=>Array(n).fill(0)),bombs:Array.from({length:n},()=>Array(n).fill(!1)),adj:Array.from({length:n},()=>Array(n).fill(0)),entry:Array.from({length:n},()=>Array(n).fill(0)),revealed:Array.from({length:n},()=>Array(n).fill(!1)),flagged:Array.from({length:n},()=>Array(n).fill(!1)),flagNote:Array.from({length:n},()=>Array(n).fill(null)),noteText:Array.from({length:n},()=>Array(n).fill("")),given:Array.from({length:n},()=>Array(n).fill(!1))}}function le(o,e){return o>=0&&o<n&&e>=0&&e<n}function ee(o,e){const t=[];for(let i=-1;i<=1;i++)for(let r=-1;r<=1;r++){if(!i&&!r)continue;const l=o+i,a=e+r;le(l,a)&&t.push([l,a])}return t}const fe=250,me=5e4;function ge(o){let e=!1,t=null,i="Unknown error",r=0,l=[],a=[],f=[],h=[];for(let d=1;d<=fe;d++){const p=ue();p.solution=pe();const B=ve(o.bombRatio);p.bombs=B.bombs,r=B.count,p.adj=V(p.bombs),Ce(p,o.supportPasses??2),p.adj=V(p.bombs);const v=be(p);if(v<(o.minStartClues||0)){i=`Not enough clues (${v} < ${o.minStartClues})`;continue}const m=ye(p,o);l=m.hintedRows,a=m.hintedCols,f=m.rowTotals,h=m.colTotals;const E=we(p,o);p.given=E.givens;for(let k=0;k<n;k++)for(let R=0;R<n;R++)p.given[k][R]&&(p.revealed[k][R]=!0,p.entry[k][R]=p.solution[k][R]);if(Se(p)){i="Board has multiple Sudoku solutions";continue}const T=Be(p,o,l,a,f,h);if(!T.solvable){i=`Not logically solvable (steps: ${T.steps})`;continue}e=!0,t=p;break}return e?{success:!0,board:t,bombsTotal:r,hintedRows:l,hintedCols:a,rowTotals:f,colTotals:h}:{success:!1,error:i}}function pe(){const o=(a,f)=>(J*(a%J)+Math.floor(a/J)+f)%n,e=[0,1,2],t=[].concat(..._([0,1,2]).map(a=>_([...e]).map(f=>a*J+f))),i=[].concat(..._([0,1,2]).map(a=>_([...e]).map(f=>a*J+f))),r=_([1,2,3,4,5,6,7,8,9]),l=Array.from({length:n},()=>Array(n).fill(0));for(let a=0;a<n;a++)for(let f=0;f<n;f++)l[t[a]][i[f]]=r[o(a,f)];return l}function ve(o){const e=n*n,t=Math.max(1,Math.floor(e*o)),i=Array.from({length:n},()=>Array(n).fill(!1)),r=[];for(let l=0;l<n;l++)for(let a=0;a<n;a++)r.push([l,a]);_(r);for(let l=0;l<t;l++){const[a,f]=r[l];i[a][f]=!0}return{bombs:i,count:t}}function V(o){const e=Array.from({length:n},()=>Array(n).fill(0));for(let t=0;t<n;t++)for(let i=0;i<n;i++)e[t][i]=ee(t,i).reduce((r,[l,a])=>r+(o[l][a]?1:0),0);return e}function be(o){let e=0;for(let t=0;t<n;t++)for(let i=0;i<n;i++)!o.bombs[t][i]&&o.solution[t][i]===o.adj[t][i]&&e++;return e}function Ce(o,e=2){const t=(i,r,l)=>ee(i,r).reduce((a,[f,h])=>a+(!o.bombs[f][h]&&o.solution[f][h]===l[f][h]?1:0),0);for(let i=0;i<e;i++){let r=!1;for(let l=0;l<n;l++)for(let a=0;a<n;a++){if(!o.bombs[l][a]||t(l,a,o.adj)>=2)continue;let h=null,d=-1;for(let p=-2;p<=2;p++)for(let B=-2;B<=2;B++){const v=l+p,m=a+B;if(!le(v,m)||o.bombs[v][m])continue;o.bombs[l][a]=!1,o.bombs[v][m]=!0;const E=V(o.bombs);let k=t(v,m,E)>=2?1e3:0;if(k)for(let R=0;R<n;R++)for(let H=0;H<n;H++)!o.bombs[R][H]&&o.solution[R][H]===E[R][H]&&k++;o.bombs[l][a]=!0,o.bombs[v][m]=!1,k>d&&(d=k,h=[v,m])}if(h){const[p,B]=h;o.bombs[l][a]=!1,o.bombs[p][B]=!0,o.adj=V(o.bombs),r=!0}}if(!r)break}}function we(o,e){const t=Math.min(e.targetStartGivens||36,n*n-1),i=Math.max(0,Math.min(e.minStartClues||0,t)),r=[],l=[];for(let s=0;s<n;s++)for(let c=0;c<n;c++){if(o.bombs[s][c])continue;const C=o.solution[s][c]===o.adj[s][c],g={r:s,c,isClue:C,adj:o.adj[s][c]};C?r.push(g):l.push(g)}const a=r.length,f=Math.max(i,Math.floor(a*(e.clueGivenRatio??1))),h=r.filter(s=>s.adj<=(e.maxAdjStart??2)),d=r.filter(s=>s.adj>(e.maxAdjStart??2)).sort((s,c)=>s.adj-c.adj),p=[];for(const s of h){if(p.length>=f)break;p.push(s)}for(const s of d){if(p.length>=f)break;p.push(s)}_(p),_(l);const B=(s,c)=>Math.floor(s/3)*3+Math.floor(c/3),v=(s,c)=>Math.hypot(s.r-c.r,s.c-c.c);let m=Math.floor(t/n)+1,E=m,T=Math.max(2,Math.ceil(t/9));const k=Array(n).fill(0),R=Array(n).fill(0),H=Array(9).fill(0),I=[];for(const s of _([0,2,6,8])){const c=g=>g.filter(b=>B(b.r,b.c)===s);let C=c(p);if(C.length||(C=c(l)),C.length){const g=C[0];I.push(g),k[g.r]++,R[g.c]++,H[B(g.r,g.c)]++;const b=(w,j)=>{const W=w.findIndex(G=>G.r===j.r&&G.c===j.c);W>=0&&w.splice(W,1)};if(b(p,g),b(l,g),I.length>=Math.min(4,t))break}}function U(s,c,C=!1,g=!0){let b=0;const w=10,j=C?2:0,W=.8,G=.6,Z=.6,z=.8;for(;b<c&&s.length;){let $=-1,Y=-1;for(let x=0;x<s.length;x++){const A=s[x],O=A.r,F=A.c,L=B(O,F);if(k[O]>=m||R[F]>=E||H[L]>=T)continue;const P=I.length?Math.min(...I.map(K=>v(K,A))):99,te=A.isClue&&A.adj<=2,X=w*P+(A.isClue?j:0)+(te?W:0)-G*k[O]-Z*R[F]-z*H[L]+Q()*.05;X>Y&&(Y=X,$=x)}if($===-1){if(!g)break;m++,E++,T<6&&T++;continue}const M=s.splice($,1)[0];I.push(M),k[M.r]++,R[M.c]++,H[B(M.r,M.c)]++,b++}return b}const y=Math.max(0,i-I.filter(s=>s.isClue).length);y>0&&U(p,y,!0);const S=Math.max(0,t-I.length);if(S>0){const s=Math.min(S,p.length);s>0&&U(p,s,!0);const c=Math.max(0,t-I.length);c>0&&U(l,c,!1)}if(e.clusterize){let z=function(M){const x=s(M.r,M.c),A=Math.ceil((e.targetStartGivens||27)/n)+2,O=A,F=Math.max(4,Math.ceil((e.targetStartGivens||27)/9)+1);return c[M.r]<A&&C[M.c]<O&&g[x]<F};var u=z;const s=(M,x)=>Math.floor(M/3)*3+Math.floor(x/3),c=Array.from(k),C=Array.from(R),g=Array.from(H),b=[];for(let M=0;M<n;M++)for(let x=0;x<n;x++)o.bombs[M][x]||o.solution[M][x]===o.adj[M][x]&&b.push({r:M,c:x,adj:o.adj[M][x]});const w=(M,x)=>I.some(A=>A.r===M&&A.c===x),j=b.filter(M=>!w(M.r,M.c)),W=j.filter(M=>M.adj>=1&&M.adj<=(e.maxAdjStart??2)),G=W.length?W.slice():j.slice();_(G);const Z=Math.min(e.minClusters??0,Math.max(0,(e.targetStartGivens||27)-I.length)),$=(M,x)=>{const A=[];for(let O=M-1;O<=M+1;O++)for(let F=x-1;F<=x+1;F++)O>=0&&O<n&&F>=0&&F<n&&!(O===M&&F===x)&&A.push([O,F]);return A};let Y=0;for(;Y<Z&&G.length&&I.length<(e.targetStartGivens||27);){let M=-1,x=-1;for(let L=0;L<Math.min(G.length,40);L++){const P=G[L],X=(I.some(K=>Math.max(Math.abs(K.r-P.r),Math.abs(K.c-P.c))<=2)?2:0)+(P.adj<=2?1:0)+Q()*.1;X>x&&z(P)&&(x=X,M=L)}if(M<0)break;const A=G.splice(M,1)[0];I.push(A),c[A.r]++,C[A.c]++,g[s(A.r,A.c)]++,Y++;let O=Math.min((e.clusterSizeMin||3)+Math.floor(Q()*((e.clusterSizeMax||5)-(e.clusterSizeMin||3)+1)),(e.targetStartGivens||27)-I.length);const F=$(A.r,A.c).map(([L,P])=>({r:L,c:P,adj:o.adj[L][P],isClue:o.solution[L][P]===o.adj[L][P]})).filter(L=>L.isClue&&!w(L.r,L.c));F.sort((L,P)=>L.adj-P.adj);for(const L of F){if(I.length>=(e.targetStartGivens||27))break;if(z(L)&&(I.push(L),c[L.r]++,C[L.c]++,g[s(L.r,L.c)]++,--O<=0))break}}}const N=Array.from({length:n},()=>Array(n).fill(!1));for(const s of I)N[s.r][s.c]=!0;return{givens:N}}function ye(o,e){const t=Array.from({length:n},(y,S)=>o.bombs[S].reduce((N,u)=>N+(u?1:0),0)),i=Array.from({length:n},(y,S)=>{let N=0;for(let u=0;u<n;u++)o.bombs[u][S]&&N++;return N}),r=(y,S)=>!o.bombs[y][S]&&o.solution[y][S]===o.adj[y][S],l=(y,S)=>ee(y,S).some(([N,u])=>r(N,u)),a=Array(n).fill(0),f=Array(n).fill(0);for(let y=0;y<n;y++)for(let S=0;S<n;S++)o.bombs[y][S]&&!l(y,S)&&(a[y]++,f[S]++);const h=Array(n).fill(0),d=Array(n).fill(0);for(let y=0;y<n;y++)for(let S=0;S<n;S++)r(y,S)&&o.adj[y][S]<=2&&(h[y]++,d[S]++);const p=10,B=6,v=1.5,m=-6,E=y=>(t[y]===0||t[y]===n?m:p)+B*a[y]+v*h[y],T=y=>(i[y]===0||i[y]===n?m:p)+B*f[y]+v*d[y],k=Array.from({length:n},(y,S)=>S).sort((y,S)=>E(S)-E(y)),R=Array.from({length:n},(y,S)=>S).sort((y,S)=>T(S)-T(y));function H(y,S){const N=[];for(const u of y){if(N.length>=S)break;N.some(s=>Math.abs(s-u)<=1)||N.push(u)}for(const u of y){if(N.length>=S)break;N.includes(u)||N.push(u)}return N.slice(0,S)}const I=H(k,Math.min(e.hintRows||0,n)),U=H(R,Math.min(e.hintCols||0,n));return{hintedRows:I,hintedCols:U,rowTotals:t,colTotals:i}}function Se(o){const e=Array.from({length:n},()=>Array(n).fill(0));for(let h=0;h<n;h++)for(let d=0;d<n;d++)!o.bombs[h][d]&&o.given[h][d]&&(e[h][d]=o.solution[h][d]);const t=(h,d)=>!o.bombs[h][d]&&o.solution[h][d]===o.adj[h][d],i=[];for(let h=0;h<n;h++)for(let d=0;d<n;d++)!o.bombs[h][d]&&!o.given[h][d]&&i.push([h,d]);if(i.length<10)return!1;let r=!1,l=0;function a(h,d,p){if(t(h,d)&&p!==o.adj[h][d])return!1;for(let m=0;m<n;m++)if(m!==d&&e[h][m]===p)return!1;for(let m=0;m<n;m++)if(m!==h&&e[m][d]===p)return!1;const B=Math.floor(h/3)*3,v=Math.floor(d/3)*3;for(let m=B;m<B+3;m++)for(let E=v;E<v+3;E++)if((m!==h||E!==d)&&e[m][E]===p)return!1;return!0}function f(h){if(r||++l>me)return;if(h===i.length){for(let m=0;m<i.length;m++){const[E,T]=i[m];if(e[E][T]!==o.solution[E][T]){r=!0;return}}return}const[d,p]=i[h],B=o.solution[d][p],v=[B];for(let m=1;m<=9;m++)m!==B&&v.push(m);for(const m of v)if(a(d,p,m)&&(e[d][p]=m,f(h+1),e[d][p]=0,r))return}return f(0),r}function Be(o,e,t,i,r,l){const a=e.logicEnforcement??"sudoku_only",f=Array.from({length:n},()=>Array(n).fill(!1)),h=Array.from({length:n},()=>Array(n).fill(!1));for(let u=0;u<n;u++)for(let s=0;s<n;s++)o.given[u][s]&&(f[u][s]=!0);const d=Array.from({length:n},()=>Array.from({length:n},()=>new Set)),p=()=>{for(let u=0;u<n;u++)for(let s=0;s<n;s++){if(o.bombs[u][s]){d[u][s].clear();continue}if(f[u][s]){d[u][s]=new Set([o.solution[u][s]]);continue}const c=new Set([1,2,3,4,5,6,7,8,9]);for(let b=0;b<n;b++)f[u][b]&&c.delete(o.solution[u][b]);for(let b=0;b<n;b++)f[b][s]&&c.delete(o.solution[b][s]);const C=Math.floor(u/3)*3,g=Math.floor(s/3)*3;for(let b=C;b<C+3;b++)for(let w=g;w<g+3;w++)f[b][w]&&c.delete(o.solution[b][w]);d[u][s]=c}},B=(u,s)=>{o.bombs[u][s]||(f[u][s]=!0)},v=(u,s)=>{f[u][s]||(h[u][s]=!0)},m=(u,s)=>{const c=[];for(let C=-1;C<=1;C++)for(let g=-1;g<=1;g++){if(!C&&!g)continue;const b=u+C,w=s+g;b>=0&&b<n&&w>=0&&w<n&&c.push([b,w])}return c},E=(u,s)=>{const c=[],C=[];for(const[g,b]of m(u,s))h[g][b]?C.push([g,b]):f[g][b]||c.push([g,b]);return{u:c,f:C}};function T(){let u=!1;for(let s=0;s<n;s++)for(let c=0;c<n;c++){if(o.bombs[s][c]||f[s][c])continue;d[s][c].size===1&&(B(s,c),u=!0)}for(let s=0;s<n;s++)for(let c=1;c<=9;c++){const C=[];for(let g=0;g<n;g++)!o.bombs[s][g]&&!f[s][g]&&d[s][g].has(c)&&C.push([s,g]);C.length===1&&(B(C[0][0],C[0][1]),u=!0)}for(let s=0;s<n;s++)for(let c=1;c<=9;c++){const C=[];for(let g=0;g<n;g++)!o.bombs[g][s]&&!f[g][s]&&d[g][s].has(c)&&C.push([g,s]);C.length===1&&(B(C[0][0],C[0][1]),u=!0)}for(let s=0;s<3;s++)for(let c=0;c<3;c++)for(let C=1;C<=9;C++){const g=[];for(let b=s*3;b<s*3+3;b++)for(let w=c*3;w<c*3+3;w++)!o.bombs[b][w]&&!f[b][w]&&d[b][w].has(C)&&g.push([b,w]);g.length===1&&(B(g[0][0],g[0][1]),u=!0)}return u}let k=0;for(;k<1e3&&(p(),!!T());k++);if(!(()=>{for(let u=0;u<n;u++)for(let s=0;s<n;s++)if(!o.bombs[u][s]&&!f[u][s])return!1;return!0})())return{solvable:!1,steps:k};if(a==="sudoku_only")return{solvable:!0,steps:k};const H=new Set(t),I=new Set(i);function U(){let u=!1;for(let s=0;s<n;s++)for(let c=0;c<n;c++){if(!f[s][c]||o.solution[s][c]!==o.adj[s][c])continue;const C=o.solution[s][c],{u:g,f:b}=E(s,c),w=b.length,j=g.length;if(j){if(w===C)for(const[W,G]of g)B(W,G),u=!0;else if(w+j===C)for(const[W,G]of g)v(W,G),u=!0}}return u}function y(){let u=!1;for(const s of H){let c=[],C=0;for(let w=0;w<n;w++)h[s][w]?C++:f[s][w]||c.push([s,w]);const g=r[s],b=c.length;if(b){if(C===g)for(const[w,j]of c)B(w,j),u=!0;else if(C+b===g)for(const[w,j]of c)v(w,j),u=!0}}for(const s of I){let c=[],C=0;for(let w=0;w<n;w++)h[w][s]?C++:f[w][s]||c.push([w,s]);const g=l[s],b=c.length;if(b){if(C===g)for(const[w,j]of c)B(w,j),u=!0;else if(C+b===g)for(const[w,j]of c)v(w,j),u=!0}}return u}for(let u=0;u<1e3&&(p(),!!(T()||U()||y()));u++);let S=0;for(let u=0;u<n;u++)for(let s=0;s<n;s++)!f[u][s]&&!h[u][s]&&S++;const N=e.maxResidualUnknownCells??0;return a==="hybrid"?{solvable:S===0,steps:k}:{solvable:S<=N,steps:k}}class Me{constructor(e,t){this.boardEl=e,this.boardWrapEl=t,this.rowHL=document.createElement("div"),this.rowHL.id="rowHL",this.rowHL.className="hlStripe",this.colHL=document.createElement("div"),this.colHL.id="colHL",this.colHL.className="hlStripe",this.boardWrapEl.appendChild(this.rowHL),this.boardWrapEl.appendChild(this.colHL)}render(e,t){this.boardEl.innerHTML="";for(let i=0;i<n;i++)for(let r=0;r<n;r++){const l=this.createCell(e,i,r,t);this.boardEl.appendChild(l)}this.highlightSelected(t.selected)}renderCell(e,t,i,r){const l=t*n+i,a=this.boardEl.children[l];a&&(this.paintCell(a,e,t,i,r),this.highlightSelected(r.selected))}createCell(e,t,i,r){const l=document.createElement("div");return this.paintCell(l,e,t,i,r),l.addEventListener("mousedown",a=>{this.onCellInteract(a,t,i)}),l.addEventListener("touchstart",a=>{a.preventDefault(),this.onCellInteract(a,t,i)},{passive:!1}),l}paintCell(e,t,i,r,l){e.innerHTML="",e.className="cell",e.dataset.r=i,e.dataset.c=r,(r+1)%3===0&&r!==n-1&&e.classList.add("bRight"),(i+1)%3===0&&i!==n-1&&e.classList.add("bBottom");const a=t.revealed[i][r],f=t.flagged[i][r],h=t.bombs[i][r],d=this.getTileType(t,i,r),p=l.selected&&l.selected.r===i&&l.selected.c===r,B=!l.gameOver&&p&&l.preview.kind;if(l.gameOver&&!l.didWin&&l.showAllBombs&&h&&!a){const v=document.createElement("div");v.className="bombmark",v.textContent="ðŸ’£",e.appendChild(v)}if(l.reviewMode&&l.gameOver&&this.paintReviewMode(e,t,i,r,a,f,h),B&&(l.preview.kind==="flag"||l.preview.kind==="note")){if(e.classList.add("covered","preview"),l.preview.kind==="flag"){const v=document.createElement("div");if(v.className="preview__flagIcon",v.textContent="âš‘",e.appendChild(v),l.preview.value!=null){const m=document.createElement("div");m.className="preview__digit",m.textContent=l.preview.value,e.appendChild(m)}}else if(l.preview.kind==="note"){const v=document.createElement("div");v.className="preview__noteIcon",v.textContent="âœŽ",e.appendChild(v);const m=document.createElement("div");m.className="preview__note",m.textContent=l.preview.value,e.appendChild(m)}return}if(a){if(e.classList.add("revealed",d),d==="bomb"){const v=document.createElement("div");v.className="bombmark",v.textContent="ðŸ’£",e.appendChild(v)}else if(t.given[i][r])e.textContent=t.solution[i][r],e.classList.add("given");else{e.classList.add("entered");const v=t.entry[i][r]||"";if(B&&l.preview.kind==="number"&&l.preview.value!=null){e.classList.add("preview");const E=document.createElement("div");E.className="preview__digit",E.textContent=l.preview.value,e.appendChild(E)}else e.textContent=v;if(l.reviewMode&&l.gameOver){const E=t.solution[i][r],T=String(v);if(T!==""&&T!==String(E)){const k=document.createElement("div");k.className="correctDigitOverlay wrong",k.textContent=E,e.appendChild(k),e.classList.add("enteredWrong")}}}return}if(e.classList.add("covered"),d==="clue"&&e.classList.add("clue"),B&&l.preview.kind==="number"){e.classList.add("preview");const v=document.createElement("div");v.className="preview__digit",v.textContent=l.preview.value,e.appendChild(v);return}if(f){e.classList.add("flag");const v=t.flagNote[i][r];if(v!=null){const m=document.createElement("div");m.className="flagDigit",m.textContent=v,e.appendChild(m)}}else{const v=t.noteText[i][r];if(v){e.classList.add("mark");const m=document.createElement("div");m.className="markDigit",m.textContent=v,e.appendChild(m)}}}paintReviewMode(e,t,i,r,l,a,f){if(!l)if(f){e.classList.add("postHiddenBomb");const h=document.createElement("div");h.className="bombmark",h.textContent="ðŸ’£",e.appendChild(h);const d=document.createElement("div");d.className="bombDigitOverlay",d.textContent=t.solution[i][r],e.appendChild(d)}else{const h=t.solution[i][r]===t.adj[i][r];e.classList.add(h?"postHiddenClue":"postHiddenSafe"),e.textContent=t.solution[i][r]}a&&(f?e.classList.add("flagRight"):e.classList.add("flagWrong"))}getTileType(e,t,i){return e.bombs[t][i]?"bomb":e.solution[t][i]===e.adj[t][i]?"clue":"normal"}onCellInteract(e,t,i){this.boardEl.dispatchEvent(new CustomEvent("cellselect",{detail:{r:t,c:i,button:e.button||0}}))}highlightSelected(e){for(const r of this.boardEl.children)r.classList.remove("sel");if(!e)return;const t=e.r*n+e.c,i=this.boardEl.children[t];i&&i.classList.add("sel")}bumpCell(e,t){const i=e*n+t,r=this.boardEl.children[i];r&&(r.classList.add("bad"),setTimeout(()=>r.classList.remove("bad"),200))}renderGutters(e,t,i,r){const l=document.getElementById("rowHintsOverlay"),a=document.getElementById("colHintsOverlay");if(!l||!a)return;l.innerHTML="",a.innerHTML="";const f=this.getBoardMetrics();e.forEach(h=>{const d=document.createElement("div");d.className="gutRow",d.style.left="8px",d.style.top=f.originY+(h+.5)*f.cellH+"px",d.textContent=`ðŸ’£ ${i[h]}`,d.addEventListener("mouseenter",()=>this.showRowHL(h)),d.addEventListener("mouseleave",()=>this.hideHL()),l.appendChild(d)}),t.forEach(h=>{const d=document.createElement("div");d.className="gutCol",d.style.top="8px",d.style.left=f.originX+(h+.5)*f.cellW+"px",d.textContent=`ðŸ’£ ${r[h]}`,d.addEventListener("mouseenter",()=>this.showColHL(h)),d.addEventListener("mouseleave",()=>this.hideHL()),a.appendChild(d)})}getBoardMetrics(){const e=this.boardWrapEl.getBoundingClientRect(),t=this.boardEl.getBoundingClientRect(),i=getComputedStyle(this.boardEl),r=parseFloat(i.paddingLeft),l=parseFloat(i.paddingTop),a=parseFloat(i.paddingRight),f=parseFloat(i.paddingBottom),h=t.width-r-a,d=t.height-l-f,p=t.left-e.left+r,B=t.top-e.top+l,v=h/n,m=d/n;return{originX:p,originY:B,innerW:h,innerH:d,cellW:v,cellH:m}}showRowHL(e){const{originX:t,originY:i,innerW:r,cellH:l}=this.getBoardMetrics();this.rowHL.style.display="block",this.rowHL.style.left=t+"px",this.rowHL.style.top=i+e*l+"px",this.rowHL.style.width=r+"px",this.rowHL.style.height=l+"px",this.colHL.style.display="none"}showColHL(e){const{originX:t,originY:i,innerH:r,cellW:l}=this.getBoardMetrics();this.colHL.style.display="block",this.colHL.style.left=t+e*l+"px",this.colHL.style.top=i+"px",this.colHL.style.width=l+"px",this.colHL.style.height=r+"px",this.rowHL.style.display="none"}hideHL(){this.rowHL.style.display="none",this.colHL.style.display="none"}}class oe{constructor(){this.board=null,this.mode="story",this.gameOver=!1,this.didWin=!1,this.reviewMode=!1,this.showAllBombs=!1,this.selected=null,this.pickedDigit=null,this.flagMode=!1,this.noteMode=!1,this.noteBuffer="",this.preview={kind:null,value:null,r:-1,c:-1},this.bombsTotal=0,this.flagsCount=0,this.hintedRows=[],this.hintedCols=[],this.rowTotals=[],this.colTotals=[],this.elements=this.getDOMElements(),this.renderer=new Me(this.elements.board,this.elements.boardWrap),this.setupEventListeners(),this.loadConfig(),this.startNewGame()}getDOMElements(){return{board:document.getElementById("board"),boardWrap:document.querySelector(".boardWrap"),status:document.getElementById("status"),bombsLeft:document.getElementById("bombsLeft"),flagsCnt:document.getElementById("flagsCnt"),mode:document.getElementById("mode"),newRunBtn:document.getElementById("newRun"),reviewBtn:document.getElementById("reviewBtn"),numpad:document.getElementById("numpad"),confirm:document.getElementById("confirm"),flagBtn:document.getElementById("flagBtn"),markBtn:document.getElementById("markBtn"),removeFlagBtn:document.getElementById("removeFlagBtn"),removeMarkBtn:document.getElementById("removeMarkBtn"),asideHint:document.getElementById("asideHint"),activeConfig:document.getElementById("activeConfig"),seedDisplay:document.getElementById("seedDisplay"),seedInput:document.getElementById("seedInput"),themeToggle:document.getElementById("themeToggle"),configPanel:document.getElementById("configPanel"),saveCustomBtn:document.getElementById("saveCustom"),resetCustomBtn:document.getElementById("resetCustom"),rowHintsOverlay:document.getElementById("rowHintsOverlay"),colHintsOverlay:document.getElementById("colHintsOverlay"),cfgLives:document.getElementById("cfgLives"),cfgBombRatio:document.getElementById("cfgBombRatio"),cfgStartClues:document.getElementById("cfgStartClues"),cfgStartGivens:document.getElementById("cfgStartGivens"),cfgMaxAdj:document.getElementById("cfgMaxAdj"),cfgSpreadRows:document.getElementById("cfgSpreadRows"),cfgSpreadBlocks:document.getElementById("cfgSpreadBlocks"),valLives:document.getElementById("valLives"),valBombRatio:document.getElementById("valBombRatio"),valStartClues:document.getElementById("valStartClues"),valStartGivens:document.getElementById("valStartGivens"),valMaxAdj:document.getElementById("valMaxAdj")}}setupControlListeners(){this.controls.on("numpad-click",e=>this.onNumpadClick(e)),this.controls.on("confirm",()=>this.onConfirm()),this.controls.on("toggle-flag",()=>this.toggleFlagMode()),this.controls.on("toggle-note",()=>this.toggleNoteMode()),this.controls.on("clear-selection",()=>{this.selected=null,this.clearPreview(),this.render()}),this.controls.on("remove-flag",()=>this.removeFlag()),this.controls.on("remove-note",()=>this.removeMark()),this.controls.on("new-game",()=>this.startNewGame()),this.controls.on("cell-select",e=>{this.onCellSelect({r:e.r,c:e.c,button:0})})}setupEventListeners(){this.elements.board.addEventListener("cellselect",e=>{this.onCellSelect(e.detail)}),this.elements.newRunBtn.addEventListener("click",()=>this.startNewGame()),this.elements.reviewBtn.addEventListener("click",()=>this.toggleReview()),this.elements.confirm.addEventListener("click",()=>this.onConfirm()),this.elements.flagBtn.addEventListener("click",()=>this.toggleFlagMode()),this.elements.markBtn.addEventListener("click",()=>this.toggleNoteMode()),this.elements.removeFlagBtn.addEventListener("click",()=>this.removeFlag()),this.elements.removeMarkBtn.addEventListener("click",()=>this.removeMark()),this.elements.mode.addEventListener("change",()=>{this.mode=this.elements.mode.value,this.updateConfigUI()}),this.elements.themeToggle.addEventListener("click",()=>this.toggleTheme()),this.setupConfigListeners(),window.addEventListener("contextmenu",e=>e.preventDefault(),{passive:!1}),window.addEventListener("resize",()=>this.renderGutters())}setupConfigListeners(){[[this.elements.cfgLives,this.elements.valLives,t=>t],[this.elements.cfgBombRatio,this.elements.valBombRatio,t=>(+t).toFixed(2)],[this.elements.cfgStartClues,this.elements.valStartClues,t=>t],[this.elements.cfgStartGivens,this.elements.valStartGivens,t=>t],[this.elements.cfgMaxAdj,this.elements.valMaxAdj,t=>t]].forEach(([t,i,r])=>{t.addEventListener("input",()=>{i.textContent=r(t.value),this.mode==="custom"&&this.syncConfigFromInputs()})}),this.elements.cfgSpreadRows.addEventListener("change",()=>{this.mode==="custom"&&this.syncConfigFromInputs()}),this.elements.cfgSpreadBlocks.addEventListener("change",()=>{this.mode==="custom"&&this.syncConfigFromInputs()}),this.elements.saveCustomBtn.addEventListener("click",()=>{this.syncConfigFromInputs(),this.setStatus("Custom config saved. New Run to apply.","win")}),this.elements.resetCustomBtn.addEventListener("click",()=>{D.custom={...D.story},this.syncInputsFromConfig(D.custom),se(D.custom),this.renderActiveConfig(),this.setStatus("Custom config reset to defaults.","hint")})}loadConfig(){const e=re();e&&(D.custom={...D.custom,...e});const t=ae();this.applyTheme(t),this.updateConfigUI()}updateConfigUI(){const e=this.getActiveConfig();this.syncInputsFromConfig(e),this.applyConfigInputsEnabled(),this.renderActiveConfig()}syncInputsFromConfig(e){this.elements.cfgLives.value=e.lives,this.elements.valLives.textContent=e.lives,this.elements.cfgBombRatio.value=e.bombRatio,this.elements.valBombRatio.textContent=Number(e.bombRatio).toFixed(2),this.elements.cfgStartClues.value=e.minStartClues,this.elements.valStartClues.textContent=e.minStartClues,this.elements.cfgStartGivens.value=e.targetStartGivens,this.elements.valStartGivens.textContent=e.targetStartGivens,this.elements.cfgMaxAdj.value=e.maxAdjStart,this.elements.valMaxAdj.textContent=e.maxAdjStart,this.elements.cfgSpreadRows.checked=!!e.spreadRows,this.elements.cfgSpreadBlocks.checked=!!e.spreadBlocks}syncConfigFromInputs(){D.custom={...D.custom,lives:parseInt(this.elements.cfgLives.value,10),bombRatio:+this.elements.cfgBombRatio.value,minStartClues:parseInt(this.elements.cfgStartClues.value,10),targetStartGivens:parseInt(this.elements.cfgStartGivens.value,10),maxAdjStart:parseInt(this.elements.cfgMaxAdj.value,10),spreadRows:!!this.elements.cfgSpreadRows.checked,spreadBlocks:!!this.elements.cfgSpreadBlocks.checked},se(D.custom),this.renderActiveConfig()}applyConfigInputsEnabled(){const e=this.mode==="custom";[this.elements.cfgLives,this.elements.cfgBombRatio,this.elements.cfgStartClues,this.elements.cfgStartGivens,this.elements.cfgMaxAdj,this.elements.cfgSpreadRows,this.elements.cfgSpreadBlocks].forEach(t=>t.disabled=!e),e&&(this.elements.configPanel.open=!0)}renderActiveConfig(){const e=this.getActiveConfig();this.elements.activeConfig.textContent=`mode: ${this.mode}
bombRatio: ${e.bombRatio}
minStartClues: ${e.minStartClues}
targetStartGivens: ${e.targetStartGivens}
maxAdjForStart: ${e.maxAdjStart}
spreadByRows: ${e.spreadRows}
spreadByBlocks: ${e.spreadBlocks}
logicEnforcement: ${e.logicEnforcement}
maxResidualUnknownCells: ${e.maxResidualUnknownCells}
clusterize: ${e.clusterize}`}getActiveConfig(){return{...D[this.mode]}}startNewGame(){this.gameOver=!1,this.didWin=!1,this.reviewMode=!1,this.showAllBombs=!1,this.selected=null,this.pickedDigit=null,this.flagsCount=0,this.flagMode=!1,this.noteMode=!1,this.noteBuffer="",this.clearPreview(),this.elements.flagBtn.classList.remove("flagModeOn"),this.elements.markBtn.classList.remove("markModeOn");const e=this.getActiveConfig(),t=this.elements.seedInput.value.trim();let i=0;const r=10,l=a=>{he(a),this.elements.seedDisplay.textContent=a;const f=ge(e);return f.success?(this.board=f.board,this.bombsTotal=f.bombsTotal,this.hintedRows=f.hintedRows,this.hintedCols=f.hintedCols,this.rowTotals=f.rowTotals,this.colTotals=f.colTotals,this.elements.reviewBtn.style.display="none",this.buildNumpad(),this.render(),this.updateStats(),this.renderActiveConfig(),this.setStatus("New game started. Good luck!","hint"),!0):!1};if(t){if(this.setStatus("Generating board with seed: "+t+"...","hint"),l(t))return;console.warn(`User seed "${t}" failed to generate valid board. Trying random seeds...`),this.setStatus("Seed failed. Trying random alternatives...","hint")}else this.setStatus("Generating board...","hint");for(;i<r;){const a=Math.floor(Math.random()*1e9).toString();if(i++,l(a)){t&&this.setStatus(`Original seed failed. Using alternative seed: ${a}`,"hint");return}console.warn(`Seed attempt ${i}/${r} failed: ${a}`)}this.setStatus("âŒ Failed to generate valid board after "+r+" attempts. Try adjusting Custom mode settings or refresh the page.","lose"),console.error("Board generation failed after",r,"seed attempts")}render(){this.renderer.render(this.board,this.getUIState()),this.updateRemoveButtons(),this.renderGutters()}renderGutters(){this.renderer.renderGutters(this.hintedRows,this.hintedCols,this.rowTotals,this.colTotals)}getUIState(){return{selected:this.selected,preview:this.preview,gameOver:this.gameOver,didWin:this.didWin,reviewMode:this.reviewMode,showAllBombs:this.showAllBombs,flagMode:this.flagMode,noteMode:this.noteMode}}onCellSelect(e){if(this.gameOver)return;const{r:t,c:i,button:r}=e;if(r===2){this.setStatus("Use Flag/Note buttons above.","hint");return}this.clearPreview(),this.selected={r:t,c:i},this.pickedDigit=null,this.noteBuffer="",this.setPreviewForSelected(),this.updateRemoveButtons(),this.updateHintText(),this.renderer.highlightSelected(this.selected)}toggleFlagMode(){this.flagMode=!this.flagMode,this.flagMode&&(this.noteMode=!1),this.elements.flagBtn.classList.toggle("flagModeOn",this.flagMode),this.elements.markBtn.classList.remove("markModeOn"),this.setStatus(this.flagMode?"Flag mode ON.":"Flag mode OFF.","hint"),this.pickedDigit=null,this.noteBuffer="",this.setPreviewForSelected(),this.updateHintText(),this.buildNumpad()}toggleNoteMode(){this.noteMode=!this.noteMode,this.noteMode&&(this.flagMode=!1),this.elements.markBtn.classList.toggle("markModeOn",this.noteMode),this.elements.flagBtn.classList.remove("flagModeOn"),this.setStatus(this.noteMode?"Note mode ON.":"Note mode OFF.","hint"),this.pickedDigit=null,this.noteBuffer="",this.setPreviewForSelected(),this.updateHintText(),this.buildNumpad()}toggleReview(){this.gameOver&&(this.reviewMode=!this.reviewMode,this.elements.reviewBtn.textContent=this.reviewMode?"â—¼ Exit Review":"ðŸ‘ Review Board",this.render())}buildNumpad(){this.elements.numpad.innerHTML="";for(let e=1;e<=9;e++){const t=document.createElement("button");t.textContent=e,t.classList.add("numBtn"),t.addEventListener("click",()=>this.onNumpadClick(e)),this.elements.numpad.appendChild(t)}if(this.noteMode){const e=document.createElement("button");e.textContent="/",e.style.fontWeight="900",e.addEventListener("click",()=>this.onSlashClick()),this.elements.numpad.appendChild(e)}}onNumpadClick(e){this.selected&&(this.noteMode?(this.noteBuffer.length&&!this.noteBuffer.endsWith("/")&&(this.noteBuffer+="/"),this.noteBuffer+=String(e)):this.pickedDigit=this.pickedDigit===e?null:e,this.setPreviewForSelected())}onSlashClick(){!this.selected||!this.noteMode||(this.noteBuffer.length&&!this.noteBuffer.endsWith("/")&&(this.noteBuffer+="/"),this.setPreviewForSelected())}onConfirm(){if(this.gameOver||!this.selected){this.setStatus("Select a tile first.","lose");return}const{r:e,c:t}=this.selected;if(this.board.given[e][t]){this.setStatus("This tile is a given.","lose"),this.renderer.bumpCell(e,t);return}this.noteMode?this.confirmNote(e,t):this.flagMode?this.confirmFlag(e,t):this.confirmNumber(e,t)}confirmNote(e,t){if(!this.noteBuffer){this.setStatus("Compose a note with digits and /.","lose"),this.renderer.bumpCell(e,t);return}this.board.entry[e][t]!=null&&(this.board.entry[e][t]=null,this.board.revealed[e][t]=!1),this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.flagsCount=Math.max(0,this.flagsCount-1),this.board.flagNote[e][t]=null),this.board.noteText[e][t]=this.noteBuffer,this.noteBuffer="",this.setStatus("Note placed.","hint"),this.clearPreview(),this.render(),this.updateStats()}confirmFlag(e,t){this.board.entry[e][t]!=null&&(this.board.entry[e][t]=null,this.board.revealed[e][t]=!1),this.board.noteText[e][t]&&(this.board.noteText[e][t]=""),this.board.flagged[e][t]||(this.board.flagged[e][t]=!0,this.flagsCount++),this.board.flagNote[e][t]=this.pickedDigit??null,this.setStatus(this.board.flagNote[e][t]==null?"Blank flag placed.":"Flag placed.","hint"),this.clearPreview(),this.render(),this.updateStats(),this.checkWin()&&this.endGame(!0,"All safe digits correct and bombs flagged!")}confirmNumber(e,t){if(this.board.bombs[e][t]){this.endGame(!1,"You touched a bomb.");return}if(this.pickedDigit==null){this.setStatus("Pick a number 1â€“9, then Confirm.","lose"),this.renderer.bumpCell(e,t);return}this.board.entry[e][t]=this.pickedDigit,this.board.revealed[e][t]=!0,this.board.noteText[e][t]&&(this.board.noteText[e][t]=""),this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.flagsCount=Math.max(0,this.flagsCount-1),this.board.flagNote[e][t]=null),this.setStatus("Digit placed.","hint"),this.clearPreview(),this.render(),this.checkWin()&&this.endGame(!0,"Perfect! All correct!")}removeFlag(){if(this.gameOver||!this.selected)return;const{r:e,c:t}=this.selected;this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.board.flagNote[e][t]=null,this.flagsCount=Math.max(0,this.flagsCount-1),this.render(),this.updateStats(),this.setStatus("Flag removed.","hint"),!this.gameOver&&this.checkWin()&&this.endGame(!0,"All correct!"))}removeMark(){if(this.gameOver||!this.selected)return;const{r:e,c:t}=this.selected;this.board.noteText[e][t]&&(this.board.noteText[e][t]="",this.render(),this.setStatus("Note cleared.","hint"))}checkWin(){for(let e=0;e<n;e++)for(let t=0;t<n;t++)if(!this.board.bombs[e][t]&&(!this.board.revealed[e][t]||(this.board.entry[e][t]|0)!==this.board.solution[e][t]))return!1;for(let e=0;e<n;e++)for(let t=0;t<n;t++)if(this.board.bombs[e][t]&&(!this.board.flagged[e][t]||(this.board.flagNote[e][t]??null)!==this.board.solution[e][t]))return!1;return!0}endGame(e,t){this.gameOver=!0,this.didWin=!!e,e?(this.showAllBombs=!1,this.setStatus("You win! "+(t||""),"win"),this.elements.reviewBtn.style.display="none"):(this.showAllBombs=!0,this.setStatus("You lose! "+(t||""),"lose"),this.elements.reviewBtn.style.display="inline-block"),this.render()}clearPreview(){const t=this.preview&&this.preview.kind&&this.preview.r>=0?{r:this.preview.r,c:this.preview.c}:null;this.preview={kind:null,value:null,r:-1,c:-1},t&&this.board&&this.renderer.renderCell(this.board,t.r,t.c,this.getUIState())}setPreviewForSelected(){if(!this.selected||this.gameOver){this.clearPreview();return}const{r:e,c:t}=this.selected;if(this.board.revealed[e][t]&&this.board.given[e][t]){this.clearPreview();return}if(this.noteMode&&this.noteBuffer)this.preview={kind:"note",value:this.noteBuffer,r:e,c:t};else if(this.flagMode)this.preview={kind:"flag",value:this.pickedDigit??null,r:e,c:t};else if(!this.noteMode&&!this.flagMode&&this.pickedDigit!=null)this.preview={kind:"number",value:this.pickedDigit,r:e,c:t};else{this.clearPreview();return}this.renderer.renderCell(this.board,e,t,this.getUIState())}updateRemoveButtons(){if(!this.selected){this.elements.removeFlagBtn.disabled=!0,this.elements.removeMarkBtn.disabled=!0;return}const{r:e,c:t}=this.selected;this.elements.removeFlagBtn.disabled=!this.board.flagged[e][t],this.elements.removeMarkBtn.disabled=!this.board.noteText[e][t]}updateHintText(){this.flagMode?this.elements.asideHint.textContent="Flag mode: optionally add a digit to the flag; Confirm to commit.":this.noteMode?this.elements.asideHint.textContent="Note mode: tap digits and '/' to compose (e.g. 2/3); Confirm to place.":this.elements.asideHint.textContent="Number mode: pick a digit; Confirm to commit. Bombs lose instantly."}updateStats(){const e=this.countCorrectFlags(),t=Math.max(0,this.bombsTotal-e);this.elements.bombsLeft.textContent="ðŸ’£ "+t,this.elements.flagsCnt.textContent=String(this.flagsCount)}countCorrectFlags(){let e=0;for(let t=0;t<n;t++)for(let i=0;i<n;i++)this.board.bombs[t][i]&&this.board.flagged[t][i]&&e++;return e}setStatus(e,t){this.elements.status.className="status "+(t||""),this.elements.status.textContent=e}toggleTheme(){const t=(document.documentElement.getAttribute("data-theme")||"dark")==="light"?"dark":"light";this.applyTheme(t),ce(t)}applyTheme(e){const t=e==="light"?"light":"dark";document.documentElement.setAttribute("data-theme",t),this.elements.themeToggle.textContent=t==="light"?"ðŸŒ™":"â˜€ï¸"}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new oe):new oe;
