(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const W={story:{lives:0,bombRatio:.16,minStartClues:14,targetStartGivens:40,maxAdjStart:2,spreadRows:!0,spreadBlocks:!0,hintRows:5,hintCols:5,logicEnforcement:"hybrid",maxResidualUnknownCells:0,clusterize:!0,minClusters:6,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:2,clueGivenRatio:.65},normal:{lives:0,bombRatio:.18,minStartClues:12,targetStartGivens:36,maxAdjStart:3,spreadRows:!0,spreadBlocks:!0,hintRows:4,hintCols:4,logicEnforcement:"hybrid",maxResidualUnknownCells:2,clusterize:!0,minClusters:5,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:1,clueGivenRatio:.5},hard:{lives:0,bombRatio:.22,minStartClues:10,targetStartGivens:32,maxAdjStart:4,spreadRows:!0,spreadBlocks:!0,hintRows:3,hintCols:3,logicEnforcement:"hybrid",maxResidualUnknownCells:4,clusterize:!0,minClusters:4,clusterSizeMin:2,clusterSizeMax:4,supportPasses:2,bootstrapSteps:1,clueGivenRatio:.5},custom:{lives:0,bombRatio:.14,minStartClues:9,targetStartGivens:36,maxAdjStart:2,spreadRows:!0,spreadBlocks:!0,hintRows:3,hintCols:3,logicEnforcement:"hybrid",maxResidualUnknownCells:2,clusterize:!0,minClusters:5,clusterSizeMin:3,clusterSizeMax:5,supportPasses:2,bootstrapSteps:1,clueGivenRatio:2/3}},l=9,K=3,oe="runic-custom-config-v2";function re(){try{const r=localStorage.getItem(oe);return r?JSON.parse(r):null}catch(r){return console.error("Failed to load custom config:",r),null}}function se(r){try{return localStorage.setItem(oe,JSON.stringify(r)),!0}catch(e){return console.error("Failed to save custom config:",e),!1}}function ae(){return localStorage.getItem("runic-theme")||"dark"}function ce(r){localStorage.setItem("runic-theme",r)}let q=1,ie=null;function de(r){let e=2166136261;for(let t=0;t<r.length;t++)e^=r.charCodeAt(t),e=Math.imul(e,16777619);return e>>>0||1}function he(r){ie=String(r),q=de(ie)}function Q(){let r=q;return r^=r<<13,r^=r>>>17,r^=r<<5,q=r>>>0,q/4294967296}function _(r){for(let e=r.length-1;e>0;e--){const t=Math.floor(Q()*(e+1));[r[e],r[t]]=[r[t],r[e]]}return r}function fe(){return{solution:Array.from({length:l},()=>Array(l).fill(0)),bombs:Array.from({length:l},()=>Array(l).fill(!1)),adj:Array.from({length:l},()=>Array(l).fill(0)),entry:Array.from({length:l},()=>Array(l).fill(0)),revealed:Array.from({length:l},()=>Array(l).fill(!1)),flagged:Array.from({length:l},()=>Array(l).fill(!1)),flagNote:Array.from({length:l},()=>Array(l).fill(null)),noteText:Array.from({length:l},()=>Array(l).fill("")),given:Array.from({length:l},()=>Array(l).fill(!1))}}function le(r,e){return r>=0&&r<l&&e>=0&&e<l}function ee(r,e){const t=[];for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){if(!s&&!n)continue;const i=r+s,a=e+n;le(i,a)&&t.push([i,a])}return t}const ue=250,me=5e4;function ge(r){let e=!1,t=null,s="Unknown error",n=0,i=[],a=[],c=[],d=[];for(let f=1;f<=ue;f++){const g=fe();g.solution=pe();const S=ve(r.bombRatio);g.bombs=S.bombs,n=S.count,g.adj=V(g.bombs),Ce(g,r.supportPasses??2),g.adj=V(g.bombs);const x=be(g);if(x<(r.minStartClues||0)){s=`Not enough clues (${x} < ${r.minStartClues})`;continue}const p=ye(g,r);i=p.hintedRows,a=p.hintedCols,c=p.rowTotals,d=p.colTotals;const C=we(g,r);g.given=C.givens;for(let E=0;E<l;E++)for(let R=0;R<l;R++)g.given[E][R]&&(g.revealed[E][R]=!0,g.entry[E][R]=g.solution[E][R]);if(ke(g)){s="Board has multiple Sudoku solutions";continue}const M=Se(g,r,i,a,c,d);if(!M.solvable){s=`Not logically solvable (steps: ${M.steps})`;continue}e=!0,t=g;break}return e?{success:!0,board:t,bombsTotal:n,hintedRows:i,hintedCols:a,rowTotals:c,colTotals:d}:{success:!1,error:s}}function pe(){const r=(a,c)=>(K*(a%K)+Math.floor(a/K)+c)%l,e=[0,1,2],t=[].concat(..._([0,1,2]).map(a=>_([...e]).map(c=>a*K+c))),s=[].concat(..._([0,1,2]).map(a=>_([...e]).map(c=>a*K+c))),n=_([1,2,3,4,5,6,7,8,9]),i=Array.from({length:l},()=>Array(l).fill(0));for(let a=0;a<l;a++)for(let c=0;c<l;c++)i[t[a]][s[c]]=n[r(a,c)];return i}function ve(r){const e=l*l,t=Math.max(1,Math.floor(e*r)),s=Array.from({length:l},()=>Array(l).fill(!1)),n=[];for(let i=0;i<l;i++)for(let a=0;a<l;a++)n.push([i,a]);_(n);for(let i=0;i<t;i++){const[a,c]=n[i];s[a][c]=!0}return{bombs:s,count:t}}function V(r){const e=Array.from({length:l},()=>Array(l).fill(0));for(let t=0;t<l;t++)for(let s=0;s<l;s++)e[t][s]=ee(t,s).reduce((n,[i,a])=>n+(r[i][a]?1:0),0);return e}function be(r){let e=0;for(let t=0;t<l;t++)for(let s=0;s<l;s++)!r.bombs[t][s]&&r.solution[t][s]===r.adj[t][s]&&e++;return e}function Ce(r,e=2){const t=(s,n,i)=>ee(s,n).reduce((a,[c,d])=>a+(!r.bombs[c][d]&&r.solution[c][d]===i[c][d]?1:0),0);for(let s=0;s<e;s++){let n=!1;for(let i=0;i<l;i++)for(let a=0;a<l;a++){if(!r.bombs[i][a]||t(i,a,r.adj)>=2)continue;let d=null,f=-1;for(let g=-2;g<=2;g++)for(let S=-2;S<=2;S++){const x=i+g,p=a+S;if(!le(x,p)||r.bombs[x][p])continue;r.bombs[i][a]=!1,r.bombs[x][p]=!0;const C=V(r.bombs);let E=t(x,p,C)>=2?1e3:0;if(E)for(let R=0;R<l;R++)for(let N=0;N<l;N++)!r.bombs[R][N]&&r.solution[R][N]===C[R][N]&&E++;r.bombs[i][a]=!0,r.bombs[x][p]=!1,E>f&&(f=E,d=[x,p])}if(d){const[g,S]=d;r.bombs[i][a]=!1,r.bombs[g][S]=!0,r.adj=V(r.bombs),n=!0}}if(!n)break}}function we(r,e){const t=Math.min(e.targetStartGivens||36,l*l-1),s=Math.max(0,Math.min(e.minStartClues||0,t)),n=[],i=[];for(let o=0;o<l;o++)for(let h=0;h<l;h++){if(r.bombs[o][h])continue;const b=r.solution[o][h]===r.adj[o][h],m={r:o,c:h,isClue:b,adj:r.adj[o][h]};b?n.push(m):i.push(m)}const a=n.length;let c;if(e.clueGivenRatio!=null&&e.clueGivenRatio<1){c=Math.floor(a*e.clueGivenRatio),c=Math.max(c,s);const o=Math.min(5,Math.floor(a*.2));c=Math.min(c,a-o)}else c=a;const d=n.filter(o=>o.adj<=(e.maxAdjStart??2)),f=n.filter(o=>o.adj>(e.maxAdjStart??2)).sort((o,h)=>o.adj-h.adj),g=[];for(const o of d){if(g.length>=c)break;g.push(o)}for(const o of f){if(g.length>=c)break;g.push(o)}_(g),_(i);const S=(o,h)=>Math.floor(o/3)*3+Math.floor(h/3),x=(o,h)=>Math.hypot(o.r-h.r,o.c-h.c);let p=Math.floor(t/l)+1,C=p,M=Math.max(2,Math.ceil(t/9));const E=Array(l).fill(0),R=Array(l).fill(0),N=Array(9).fill(0),T=[];for(const o of _([0,2,6,8])){const h=m=>m.filter(v=>S(v.r,v.c)===o);let b=h(g);if(b.length||(b=h(i)),b.length){const m=b[0];T.push(m),E[m.r]++,R[m.c]++,N[S(m.r,m.c)]++;const v=(w,j)=>{const P=w.findIndex(F=>F.r===j.r&&F.c===j.c);P>=0&&w.splice(P,1)};if(v(g,m),v(i,m),T.length>=Math.min(4,t))break}}function U(o,h,b=!1,m=!0){let v=0;const w=10,j=b?2:0,P=.8,F=.6,Z=.6,z=.8;for(;v<h&&o.length;){let $=-1,X=-1;for(let A=0;A<o.length;A++){const I=o[A],G=I.r,H=I.c,L=S(G,H);if(E[G]>=p||R[H]>=C||N[L]>=M)continue;const O=T.length?Math.min(...T.map(J=>x(J,I))):99,te=I.isClue&&I.adj<=2,Y=w*O+(I.isClue?j:0)+(te?P:0)-F*E[G]-Z*R[H]-z*N[L]+Q()*.05;Y>X&&(X=Y,$=A)}if($===-1){if(!m)break;p++,C++,M<6&&M++;continue}const B=o.splice($,1)[0];T.push(B),E[B.r]++,R[B.c]++,N[S(B.r,B.c)]++,v++}return v}const y=Math.max(0,s-T.filter(o=>o.isClue).length);y>0&&U(g,y,!0);const k=Math.max(0,t-T.length);if(k>0){const o=Math.min(k,g.length);o>0&&U(g,o,!0);const h=Math.max(0,t-T.length);h>0&&U(i,h,!1)}if(e.clusterize){let z=function(B){const A=o(B.r,B.c),I=Math.ceil((e.targetStartGivens||27)/l)+2,G=I,H=Math.max(4,Math.ceil((e.targetStartGivens||27)/9)+1);return h[B.r]<I&&b[B.c]<G&&m[A]<H};var u=z;const o=(B,A)=>Math.floor(B/3)*3+Math.floor(A/3),h=Array.from(E),b=Array.from(R),m=Array.from(N),v=[];for(let B=0;B<l;B++)for(let A=0;A<l;A++)r.bombs[B][A]||r.solution[B][A]===r.adj[B][A]&&v.push({r:B,c:A,adj:r.adj[B][A]});const w=(B,A)=>T.some(I=>I.r===B&&I.c===A),j=v.filter(B=>!w(B.r,B.c)),P=j.filter(B=>B.adj>=1&&B.adj<=(e.maxAdjStart??2)),F=P.length?P.slice():j.slice();_(F);const Z=Math.min(e.minClusters??0,Math.max(0,(e.targetStartGivens||27)-T.length)),$=(B,A)=>{const I=[];for(let G=B-1;G<=B+1;G++)for(let H=A-1;H<=A+1;H++)G>=0&&G<l&&H>=0&&H<l&&!(G===B&&H===A)&&I.push([G,H]);return I};let X=0;for(;X<Z&&F.length&&T.length<(e.targetStartGivens||27);){let B=-1,A=-1;for(let L=0;L<Math.min(F.length,40);L++){const O=F[L],Y=(T.some(J=>Math.max(Math.abs(J.r-O.r),Math.abs(J.c-O.c))<=2)?2:0)+(O.adj<=2?1:0)+Q()*.1;Y>A&&z(O)&&(A=Y,B=L)}if(B<0)break;const I=F.splice(B,1)[0];T.push(I),h[I.r]++,b[I.c]++,m[o(I.r,I.c)]++,X++;let G=Math.min((e.clusterSizeMin||3)+Math.floor(Q()*((e.clusterSizeMax||5)-(e.clusterSizeMin||3)+1)),(e.targetStartGivens||27)-T.length);const H=$(I.r,I.c).map(([L,O])=>({r:L,c:O,adj:r.adj[L][O],isClue:r.solution[L][O]===r.adj[L][O]})).filter(L=>L.isClue&&!w(L.r,L.c));H.sort((L,O)=>L.adj-O.adj);for(const L of H){if(T.length>=(e.targetStartGivens||27))break;if(z(L)&&(T.push(L),h[L.r]++,b[L.c]++,m[o(L.r,L.c)]++,--G<=0))break}}}const D=Array.from({length:l},()=>Array(l).fill(!1));for(const o of T)D[o.r][o.c]=!0;return{givens:D}}function ye(r,e){const t=Array.from({length:l},(y,k)=>r.bombs[k].reduce((D,u)=>D+(u?1:0),0)),s=Array.from({length:l},(y,k)=>{let D=0;for(let u=0;u<l;u++)r.bombs[u][k]&&D++;return D}),n=(y,k)=>!r.bombs[y][k]&&r.solution[y][k]===r.adj[y][k],i=(y,k)=>ee(y,k).some(([D,u])=>n(D,u)),a=Array(l).fill(0),c=Array(l).fill(0);for(let y=0;y<l;y++)for(let k=0;k<l;k++)r.bombs[y][k]&&!i(y,k)&&(a[y]++,c[k]++);const d=Array(l).fill(0),f=Array(l).fill(0);for(let y=0;y<l;y++)for(let k=0;k<l;k++)n(y,k)&&r.adj[y][k]<=2&&(d[y]++,f[k]++);const g=10,S=6,x=1.5,p=-6,C=y=>(t[y]===0||t[y]===l?p:g)+S*a[y]+x*d[y],M=y=>(s[y]===0||s[y]===l?p:g)+S*c[y]+x*f[y],E=Array.from({length:l},(y,k)=>k).sort((y,k)=>C(k)-C(y)),R=Array.from({length:l},(y,k)=>k).sort((y,k)=>M(k)-M(y));function N(y,k){const D=[];for(const u of y){if(D.length>=k)break;D.some(o=>Math.abs(o-u)<=1)||D.push(u)}for(const u of y){if(D.length>=k)break;D.includes(u)||D.push(u)}return D.slice(0,k)}const T=N(E,Math.min(e.hintRows||0,l)),U=N(R,Math.min(e.hintCols||0,l));return{hintedRows:T,hintedCols:U,rowTotals:t,colTotals:s}}function ke(r){const e=Array.from({length:l},()=>Array(l).fill(0));for(let d=0;d<l;d++)for(let f=0;f<l;f++)!r.bombs[d][f]&&r.given[d][f]&&(e[d][f]=r.solution[d][f]);const t=(d,f)=>!r.bombs[d][f]&&r.solution[d][f]===r.adj[d][f],s=[];for(let d=0;d<l;d++)for(let f=0;f<l;f++)!r.bombs[d][f]&&!r.given[d][f]&&s.push([d,f]);if(s.length<10)return!1;let n=!1,i=0;function a(d,f,g){if(t(d,f)&&g!==r.adj[d][f])return!1;for(let p=0;p<l;p++)if(p!==f&&e[d][p]===g)return!1;for(let p=0;p<l;p++)if(p!==d&&e[p][f]===g)return!1;const S=Math.floor(d/3)*3,x=Math.floor(f/3)*3;for(let p=S;p<S+3;p++)for(let C=x;C<x+3;C++)if((p!==d||C!==f)&&e[p][C]===g)return!1;return!0}function c(d){if(n||++i>me)return;if(d===s.length){for(let p=0;p<s.length;p++){const[C,M]=s[p];if(e[C][M]!==r.solution[C][M]){n=!0;return}}return}const[f,g]=s[d],S=r.solution[f][g],x=[S];for(let p=1;p<=9;p++)p!==S&&x.push(p);for(const p of x)if(a(f,g,p)&&(e[f][g]=p,c(d+1),e[f][g]=0,n))return}return c(0),n}function Se(r,e,t,s,n,i){const a=e.logicEnforcement??"sudoku_only",c=Array.from({length:l},()=>Array(l).fill(!1)),d=Array.from({length:l},()=>Array(l).fill(!1));for(let u=0;u<l;u++)for(let o=0;o<l;o++)r.given[u][o]&&(c[u][o]=!0);const f=Array.from({length:l},()=>Array.from({length:l},()=>new Set)),g=()=>{for(let u=0;u<l;u++)for(let o=0;o<l;o++){if(r.bombs[u][o]){f[u][o].clear();continue}if(c[u][o]){f[u][o]=new Set([r.solution[u][o]]);continue}const h=new Set([1,2,3,4,5,6,7,8,9]);for(let v=0;v<l;v++)c[u][v]&&h.delete(r.solution[u][v]);for(let v=0;v<l;v++)c[v][o]&&h.delete(r.solution[v][o]);const b=Math.floor(u/3)*3,m=Math.floor(o/3)*3;for(let v=b;v<b+3;v++)for(let w=m;w<m+3;w++)c[v][w]&&h.delete(r.solution[v][w]);f[u][o]=h}},S=(u,o)=>{r.bombs[u][o]||(c[u][o]=!0)},x=(u,o)=>{c[u][o]||(d[u][o]=!0)},p=(u,o)=>{const h=[];for(let b=-1;b<=1;b++)for(let m=-1;m<=1;m++){if(!b&&!m)continue;const v=u+b,w=o+m;v>=0&&v<l&&w>=0&&w<l&&h.push([v,w])}return h},C=(u,o)=>{const h=[],b=[];for(const[m,v]of p(u,o))d[m][v]?b.push([m,v]):c[m][v]||h.push([m,v]);return{u:h,f:b}};function M(){let u=!1;for(let o=0;o<l;o++)for(let h=0;h<l;h++){if(r.bombs[o][h]||c[o][h])continue;f[o][h].size===1&&(S(o,h),u=!0)}for(let o=0;o<l;o++)for(let h=1;h<=9;h++){const b=[];for(let m=0;m<l;m++)!r.bombs[o][m]&&!c[o][m]&&f[o][m].has(h)&&b.push([o,m]);b.length===1&&(S(b[0][0],b[0][1]),u=!0)}for(let o=0;o<l;o++)for(let h=1;h<=9;h++){const b=[];for(let m=0;m<l;m++)!r.bombs[m][o]&&!c[m][o]&&f[m][o].has(h)&&b.push([m,o]);b.length===1&&(S(b[0][0],b[0][1]),u=!0)}for(let o=0;o<3;o++)for(let h=0;h<3;h++)for(let b=1;b<=9;b++){const m=[];for(let v=o*3;v<o*3+3;v++)for(let w=h*3;w<h*3+3;w++)!r.bombs[v][w]&&!c[v][w]&&f[v][w].has(b)&&m.push([v,w]);m.length===1&&(S(m[0][0],m[0][1]),u=!0)}return u}let E=0;for(;E<1e3&&(g(),!!M());E++);if(!(()=>{for(let u=0;u<l;u++)for(let o=0;o<l;o++)if(!r.bombs[u][o]&&!c[u][o])return!1;return!0})())return{solvable:!1,steps:E};if(a==="sudoku_only")return{solvable:!0,steps:E};const N=new Set(t),T=new Set(s);function U(){let u=!1;for(let o=0;o<l;o++)for(let h=0;h<l;h++){if(!c[o][h]||r.solution[o][h]!==r.adj[o][h])continue;const b=r.solution[o][h],{u:m,f:v}=C(o,h),w=v.length,j=m.length;if(j){if(w===b)for(const[P,F]of m)S(P,F),u=!0;else if(w+j===b)for(const[P,F]of m)x(P,F),u=!0}}return u}function y(){let u=!1;for(const o of N){let h=[],b=0;for(let w=0;w<l;w++)d[o][w]?b++:c[o][w]||h.push([o,w]);const m=n[o],v=h.length;if(v){if(b===m)for(const[w,j]of h)S(w,j),u=!0;else if(b+v===m)for(const[w,j]of h)x(w,j),u=!0}}for(const o of T){let h=[],b=0;for(let w=0;w<l;w++)d[w][o]?b++:c[w][o]||h.push([w,o]);const m=i[o],v=h.length;if(v){if(b===m)for(const[w,j]of h)S(w,j),u=!0;else if(b+v===m)for(const[w,j]of h)x(w,j),u=!0}}return u}for(let u=0;u<1e3&&(g(),!!(M()||U()||y()));u++);let k=0;for(let u=0;u<l;u++)for(let o=0;o<l;o++)!c[u][o]&&!d[u][o]&&k++;const D=e.maxResidualUnknownCells??0;return a==="hybrid"?{solvable:k===0,steps:E}:{solvable:k<=D,steps:E}}class Be{constructor(e,t){this.boardEl=e,this.boardWrapEl=t,this.lastBoard=null,this.rowHL=document.createElement("div"),this.rowHL.id="rowHL",this.rowHL.className="hlStripe",this.colHL=document.createElement("div"),this.colHL.id="colHL",this.colHL.className="hlStripe",this.boardWrapEl.appendChild(this.rowHL),this.boardWrapEl.appendChild(this.colHL)}render(e,t){this.lastBoard=e,this.boardEl.innerHTML="";for(let s=0;s<l;s++)for(let n=0;n<l;n++){const i=this.createCell(e,s,n,t);this.boardEl.appendChild(i)}this.highlightSelected(t.selected)}renderCell(e,t,s,n){const i=t*l+s,a=this.boardEl.children[i];a&&(this.paintCell(a,e,t,s,n),this.highlightSelected(n.selected))}createCell(e,t,s,n){const i=document.createElement("div");return this.paintCell(i,e,t,s,n),i.addEventListener("mousedown",a=>{this.onCellInteract(a,t,s)}),i.addEventListener("touchstart",a=>{a.preventDefault(),this.onCellInteract(a,t,s)},{passive:!1}),i}paintCell(e,t,s,n,i){e.innerHTML="",e.className="cell",e.dataset.r=s,e.dataset.c=n;const a=[1,3,5,7,9,11,13,15,17],c=[1,3,5,7,9,11,13,15,17];e.style.gridColumn=a[n],e.style.gridRow=c[s],t.given[s][n]?e.style.cursor="not-allowed":e.style.cursor="pointer";const d=t.revealed[s][n],f=t.flagged[s][n],g=t.bombs[s][n],S=this.getTileType(t,s,n),x=i.selected&&i.selected.r===s&&i.selected.c===n,p=!i.gameOver&&x&&i.preview.kind;if(i.gameOver&&!i.didWin&&i.showAllBombs&&g&&!d){const C=document.createElement("div");C.className="bombmark",C.textContent="ðŸ’£",e.appendChild(C)}if(i.reviewMode&&i.gameOver&&this.paintReviewMode(e,t,s,n,d,f,g),p&&(i.preview.kind==="flag"||i.preview.kind==="note")){if(e.classList.add("covered","preview"),i.preview.kind==="flag"){const C=document.createElement("div");if(C.className="preview__flagIcon",C.textContent="âš‘",e.appendChild(C),i.preview.value!=null){const M=document.createElement("div");M.className="preview__digit",M.textContent=i.preview.value,e.appendChild(M)}}else if(i.preview.kind==="note"){const C=document.createElement("div");C.className="preview__noteIcon",C.textContent="âœŽ",e.appendChild(C);const M=document.createElement("div");M.className="preview__note",M.textContent=i.preview.value,e.appendChild(M)}return}if(d){if(e.classList.add("revealed",S),S==="bomb"){const C=document.createElement("div");C.className="bombmark",C.textContent="ðŸ’£",e.appendChild(C)}else if(t.given[s][n])e.textContent=t.solution[s][n],e.classList.add("given");else{e.classList.add("entered");const C=t.entry[s][n]||"";if(p&&i.preview.kind==="number"&&i.preview.value!=null){e.classList.add("preview");const E=document.createElement("div");E.className="preview__digit",E.textContent=i.preview.value,e.appendChild(E)}else e.textContent=C;if(i.reviewMode&&i.gameOver){const E=t.solution[s][n],R=String(C);if(R!==""&&R!==String(E)){const N=document.createElement("div");N.className="correctDigitOverlay wrong",N.textContent=E,e.appendChild(N),e.classList.add("enteredWrong")}}}return}if(e.classList.add("covered"),S==="clue"&&e.classList.add("clue"),p&&i.preview.kind==="number"){e.classList.add("preview");const C=document.createElement("div");C.className="preview__digit",C.textContent=i.preview.value,e.appendChild(C);return}if(f){e.classList.add("flag");const C=t.flagNote[s][n];if(C!=null){const M=document.createElement("div");M.className="flagDigit",M.textContent=C,e.appendChild(M)}}else{const C=t.noteText[s][n];if(C){e.classList.add("mark");const M=document.createElement("div");M.className="markDigit",M.textContent=C,e.appendChild(M)}}}paintReviewMode(e,t,s,n,i,a,c){if(!i)if(c){e.classList.add("postHiddenBomb");const d=document.createElement("div");d.className="bombmark",d.textContent="ðŸ’£",e.appendChild(d);const f=document.createElement("div");f.className="bombDigitOverlay",f.textContent=t.solution[s][n],e.appendChild(f)}else{const d=t.solution[s][n]===t.adj[s][n];e.classList.add(d?"postHiddenClue":"postHiddenSafe"),e.textContent=t.solution[s][n]}a&&(c?e.classList.add("flagRight"):e.classList.add("flagWrong"))}getTileType(e,t,s){return e.bombs[t][s]?"bomb":e.solution[t][s]===e.adj[t][s]?"clue":"normal"}onCellInteract(e,t,s){const n=this.lastBoard;n&&n.given[t][s]||this.boardEl.dispatchEvent(new CustomEvent("cellselect",{detail:{r:t,c:s,button:e.button||0}}))}highlightSelected(e){for(const n of this.boardEl.children)n.classList.remove("sel");if(!e)return;const t=e.r*l+e.c,s=this.boardEl.children[t];s&&s.classList.add("sel")}bumpCell(e,t){const s=e*l+t,n=this.boardEl.children[s];n&&(n.classList.add("bad"),setTimeout(()=>n.classList.remove("bad"),200))}renderGutters(e,t,s,n){const i=document.getElementById("rowHintsOverlay"),a=document.getElementById("colHintsOverlay");if(!i||!a)return;i.innerHTML="",a.innerHTML="";const c=this.getBoardMetrics();e.forEach(d=>{const f=document.createElement("div");f.className="gutRow",f.style.left="8px",f.style.top=c.originY+(d+.5)*c.cellH+"px",f.textContent=`ðŸ’£ ${s[d]}`,f.addEventListener("mouseenter",()=>this.showRowHL(d)),f.addEventListener("mouseleave",()=>this.hideHL()),i.appendChild(f)}),t.forEach(d=>{const f=document.createElement("div");f.className="gutCol",f.style.top="8px",f.style.left=c.originX+(d+.5)*c.cellW+"px",f.textContent=`ðŸ’£ ${n[d]}`,f.addEventListener("mouseenter",()=>this.showColHL(d)),f.addEventListener("mouseleave",()=>this.hideHL()),a.appendChild(f)})}getBoardMetrics(){const e=this.boardWrapEl.getBoundingClientRect(),t=this.boardEl.getBoundingClientRect(),s=getComputedStyle(this.boardEl),n=parseFloat(s.paddingLeft),i=parseFloat(s.paddingTop),a=parseFloat(s.paddingRight),c=parseFloat(s.paddingBottom),d=t.width-n-a,f=t.height-i-c,g=t.left-e.left+n,S=t.top-e.top+i,x=d/l,p=f/l;return{originX:g,originY:S,innerW:d,innerH:f,cellW:x,cellH:p}}showRowHL(e){const{originX:t,originY:s,innerW:n,cellH:i}=this.getBoardMetrics();this.rowHL.style.display="block",this.rowHL.style.left=t+"px",this.rowHL.style.top=s+e*i+"px",this.rowHL.style.width=n+"px",this.rowHL.style.height=i+"px",this.colHL.style.display="none"}showColHL(e){const{originX:t,originY:s,innerH:n,cellW:i}=this.getBoardMetrics();this.colHL.style.display="block",this.colHL.style.left=t+e*i+"px",this.colHL.style.top=s+"px",this.colHL.style.width=i+"px",this.colHL.style.height=n+"px",this.rowHL.style.display="none"}hideHL(){this.rowHL.style.display="none",this.colHL.style.display="none"}}class ne{constructor(){this.board=null,this.mode="story",this.gameOver=!1,this.didWin=!1,this.reviewMode=!1,this.showAllBombs=!1,this.selected=null,this.pickedDigit=null,this.flagMode=!1,this.noteMode=!1,this.noteBuffer="",this.preview={kind:null,value:null,r:-1,c:-1},this.bombsTotal=0,this.flagsCount=0,this.hintedRows=[],this.hintedCols=[],this.rowTotals=[],this.colTotals=[],this.elements=this.getDOMElements(),this.renderer=new Be(this.elements.board,this.elements.boardWrap),this.setupEventListeners(),this.setupKeyboardShortcuts(),this.loadConfig(),this.startNewGame()}getDOMElements(){return{board:document.getElementById("board"),boardWrap:document.querySelector(".boardWrap"),status:document.getElementById("status"),bombsLeft:document.getElementById("bombsLeft"),flagsCnt:document.getElementById("flagsCnt"),mode:document.getElementById("mode"),newRunBtn:document.getElementById("newRun"),reviewBtn:document.getElementById("reviewBtn"),numpad:document.getElementById("numpad"),confirm:document.getElementById("confirm"),flagBtn:document.getElementById("flagBtn"),markBtn:document.getElementById("markBtn"),removeFlagBtn:document.getElementById("removeFlagBtn"),removeMarkBtn:document.getElementById("removeMarkBtn"),asideHint:document.getElementById("asideHint"),activeConfig:document.getElementById("activeConfig"),seedDisplay:document.getElementById("seedDisplay"),seedInput:document.getElementById("seedInput"),themeToggle:document.getElementById("themeToggle"),configPanel:document.getElementById("configPanel"),saveCustomBtn:document.getElementById("saveCustom"),resetCustomBtn:document.getElementById("resetCustom"),rowHintsOverlay:document.getElementById("rowHintsOverlay"),colHintsOverlay:document.getElementById("colHintsOverlay"),cfgLives:document.getElementById("cfgLives"),cfgBombRatio:document.getElementById("cfgBombRatio"),cfgStartClues:document.getElementById("cfgStartClues"),cfgStartGivens:document.getElementById("cfgStartGivens"),cfgMaxAdj:document.getElementById("cfgMaxAdj"),cfgSpreadRows:document.getElementById("cfgSpreadRows"),cfgSpreadBlocks:document.getElementById("cfgSpreadBlocks"),valLives:document.getElementById("valLives"),valBombRatio:document.getElementById("valBombRatio"),valStartClues:document.getElementById("valStartClues"),valStartGivens:document.getElementById("valStartGivens"),valMaxAdj:document.getElementById("valMaxAdj")}}setupControlListeners(){this.controls.on("numpad-click",e=>this.onNumpadClick(e)),this.controls.on("confirm",()=>this.onConfirm()),this.controls.on("toggle-flag",()=>this.toggleFlagMode()),this.controls.on("toggle-note",()=>this.toggleNoteMode()),this.controls.on("clear-selection",()=>{this.selected=null,this.clearPreview(),this.render()}),this.controls.on("remove-flag",()=>this.removeFlag()),this.controls.on("remove-note",()=>this.removeMark()),this.controls.on("new-game",()=>this.startNewGame()),this.controls.on("cell-select",e=>{this.onCellSelect({r:e.r,c:e.c,button:0})})}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||!this.board||this.gameOver)return;const t=["1","2","3","4","5","6","7","8","9","Enter"," ","f","m","Escape","Delete","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if((t.includes(e.key)||t.includes(e.key.toLowerCase()))&&e.preventDefault(),e.key>="1"&&e.key<="9"){const s=parseInt(e.key);this.noteMode?(this.noteBuffer.length&&!this.noteBuffer.endsWith("/")&&(this.noteBuffer+="/"),this.noteBuffer+=String(s)):this.pickedDigit=this.pickedDigit===s?null:s,this.setPreviewForSelected();return}if(e.key==="Enter"||e.key===" "){this.onConfirm();return}if(e.key==="f"||e.key==="F"){this.toggleFlagMode();return}if(e.key==="m"||e.key==="M"){this.toggleNoteMode();return}if(e.key==="Escape"){this.selected&&(this.selected=null,this.pickedDigit=null,this.noteBuffer="",this.clearPreview(),this.updateRemoveButtons(),this.renderer.highlightSelected(null),this.setStatus("Tile unselected.","hint"));return}if(e.key==="Delete"||e.key==="Backspace"){if(!this.selected)return;const{r:s,c:n}=this.selected;this.board.flagged[s][n]?this.removeFlag():this.board.noteText[s][n]&&this.removeMark();return}if(e.key.startsWith("Arrow")){if(this.selected){let{r:i,c:a}=this.selected;switch(e.key){case"ArrowUp":i=Math.max(0,i-1);break;case"ArrowDown":i=Math.min(8,i+1);break;case"ArrowLeft":a=Math.max(0,a-1);break;case"ArrowRight":a=Math.min(8,a+1);break}let c=0;for(;this.board.given[i][a]&&c<9;){switch(e.key){case"ArrowUp":i--,i<0&&(i=8);break;case"ArrowDown":i++,i>8&&(i=0);break;case"ArrowLeft":a--,a<0&&(a=8);break;case"ArrowRight":a++,a>8&&(a=0);break}c++}this.selected={r:i,c:a}}else{this.selected={r:4,c:4};let i=!1;for(let a=0;a<9&&!i;a++)for(let c=0;c<9;c++){for(let d=0;d<9;d++)if(Math.abs(c-4)+Math.abs(d-4)===a&&!this.board.given[c][d]){this.selected={r:c,c:d},i=!0;break}if(i)break}}this.clearPreview();const{r:s,c:n}=this.selected;if(this.flagMode)if(this.board.entry[s][n])this.pickedDigit=this.board.entry[s][n];else if(this.board.flagNote[s][n])this.pickedDigit=this.board.flagNote[s][n];else if(this.board.noteText[s][n]){const i=this.board.noteText[s][n].match(/\d/);this.pickedDigit=i?parseInt(i[0]):null}else this.pickedDigit=null;else this.noteMode?this.board.noteText[s][n]?this.noteBuffer=this.board.noteText[s][n]:this.board.entry[s][n]?this.noteBuffer=String(this.board.entry[s][n]):this.noteBuffer="":(this.pickedDigit=null,this.noteBuffer="");this.setPreviewForSelected(),this.updateRemoveButtons(),this.renderer.highlightSelected(this.selected);return}})}setupEventListeners(){this.elements.board.addEventListener("cellselect",e=>{this.onCellSelect(e.detail)}),this.elements.newRunBtn.addEventListener("click",()=>this.startNewGame()),this.elements.reviewBtn.addEventListener("click",()=>this.toggleReview()),this.elements.confirm.addEventListener("click",()=>this.onConfirm()),this.elements.flagBtn.addEventListener("click",()=>this.toggleFlagMode()),this.elements.markBtn.addEventListener("click",()=>this.toggleNoteMode()),this.elements.removeFlagBtn.addEventListener("click",()=>this.removeFlag()),this.elements.removeMarkBtn.addEventListener("click",()=>this.removeMark()),this.elements.mode.addEventListener("change",()=>{this.mode=this.elements.mode.value,this.updateConfigUI()}),this.elements.themeToggle.addEventListener("click",()=>this.toggleTheme()),this.setupConfigListeners(),window.addEventListener("contextmenu",e=>e.preventDefault(),{passive:!1}),window.addEventListener("resize",()=>{this.renderGutters()})}setupConfigListeners(){[[this.elements.cfgLives,this.elements.valLives,t=>t],[this.elements.cfgBombRatio,this.elements.valBombRatio,t=>(+t).toFixed(2)],[this.elements.cfgStartClues,this.elements.valStartClues,t=>t],[this.elements.cfgStartGivens,this.elements.valStartGivens,t=>t],[this.elements.cfgMaxAdj,this.elements.valMaxAdj,t=>t]].forEach(([t,s,n])=>{t.addEventListener("input",()=>{s.textContent=n(t.value),this.mode==="custom"&&this.syncConfigFromInputs()})}),this.elements.cfgSpreadRows.addEventListener("change",()=>{this.mode==="custom"&&this.syncConfigFromInputs()}),this.elements.cfgSpreadBlocks.addEventListener("change",()=>{this.mode==="custom"&&this.syncConfigFromInputs()}),this.elements.saveCustomBtn.addEventListener("click",()=>{this.syncConfigFromInputs(),this.setStatus("Custom config saved. New Run to apply.","win")}),this.elements.resetCustomBtn.addEventListener("click",()=>{W.custom={...W.story},this.syncInputsFromConfig(W.custom),se(W.custom),this.renderActiveConfig(),this.setStatus("Custom config reset to defaults.","hint")})}loadConfig(){const e=re();e&&(W.custom={...W.custom,...e});const t=ae();this.applyTheme(t),this.updateConfigUI()}updateConfigUI(){const e=this.getActiveConfig();this.syncInputsFromConfig(e),this.applyConfigInputsEnabled(),this.renderActiveConfig()}syncInputsFromConfig(e){this.elements.cfgLives.value=e.lives,this.elements.valLives.textContent=e.lives,this.elements.cfgBombRatio.value=e.bombRatio,this.elements.valBombRatio.textContent=Number(e.bombRatio).toFixed(2),this.elements.cfgStartClues.value=e.minStartClues,this.elements.valStartClues.textContent=e.minStartClues,this.elements.cfgStartGivens.value=e.targetStartGivens,this.elements.valStartGivens.textContent=e.targetStartGivens,this.elements.cfgMaxAdj.value=e.maxAdjStart,this.elements.valMaxAdj.textContent=e.maxAdjStart,this.elements.cfgSpreadRows.checked=!!e.spreadRows,this.elements.cfgSpreadBlocks.checked=!!e.spreadBlocks}syncConfigFromInputs(){W.custom={...W.custom,lives:parseInt(this.elements.cfgLives.value,10),bombRatio:+this.elements.cfgBombRatio.value,minStartClues:parseInt(this.elements.cfgStartClues.value,10),targetStartGivens:parseInt(this.elements.cfgStartGivens.value,10),maxAdjStart:parseInt(this.elements.cfgMaxAdj.value,10),spreadRows:!!this.elements.cfgSpreadRows.checked,spreadBlocks:!!this.elements.cfgSpreadBlocks.checked},se(W.custom),this.renderActiveConfig()}applyConfigInputsEnabled(){const e=this.mode==="custom";[this.elements.cfgLives,this.elements.cfgBombRatio,this.elements.cfgStartClues,this.elements.cfgStartGivens,this.elements.cfgMaxAdj,this.elements.cfgSpreadRows,this.elements.cfgSpreadBlocks].forEach(t=>t.disabled=!e),e&&(this.elements.configPanel.open=!0)}renderActiveConfig(){const e=this.getActiveConfig();this.elements.activeConfig.textContent=`mode: ${this.mode}
bombRatio: ${e.bombRatio}
minStartClues: ${e.minStartClues}
targetStartGivens: ${e.targetStartGivens}
maxAdjForStart: ${e.maxAdjStart}
spreadByRows: ${e.spreadRows}
spreadByBlocks: ${e.spreadBlocks}
logicEnforcement: ${e.logicEnforcement}
maxResidualUnknownCells: ${e.maxResidualUnknownCells}
clusterize: ${e.clusterize}`}getActiveConfig(){return{...W[this.mode]}}startNewGame(){this.gameOver=!1,this.didWin=!1,this.reviewMode=!1,this.showAllBombs=!1,this.selected=null,this.pickedDigit=null,this.flagsCount=0,this.flagMode=!1,this.noteMode=!1,this.noteBuffer="",this.clearPreview(),this.elements.flagBtn.classList.remove("flagModeOn"),this.elements.markBtn.classList.remove("markModeOn");const e=this.getActiveConfig(),t=this.elements.seedInput.value.trim();let s=0;const n=10,i=a=>{he(a),this.elements.seedDisplay.textContent=a;const c=ge(e);return c.success?(this.board=c.board,this.bombsTotal=c.bombsTotal,this.hintedRows=c.hintedRows,this.hintedCols=c.hintedCols,this.rowTotals=c.rowTotals,this.colTotals=c.colTotals,this.elements.reviewBtn.style.display="none",this.buildNumpad(),this.render(),this.updateStats(),this.renderActiveConfig(),this.setStatus("New game started. Good luck!","hint"),!0):!1};if(t){if(this.setStatus("Generating board with seed: "+t+"...","hint"),i(t))return;console.warn(`User seed "${t}" failed to generate valid board. Trying random seeds...`),this.setStatus("Seed failed. Trying random alternatives...","hint")}else this.setStatus("Generating board...","hint");for(;s<n;){const a=Math.floor(Math.random()*1e9).toString();if(s++,i(a)){t&&this.setStatus(`Original seed failed. Using alternative seed: ${a}`,"hint");return}console.warn(`Seed attempt ${s}/${n} failed: ${a}`)}this.setStatus("âŒ Failed to generate valid board after "+n+" attempts. Try adjusting Custom mode settings or refresh the page.","lose"),console.error("Board generation failed after",n,"seed attempts")}render(){this.renderer.render(this.board,this.getUIState()),this.updateRemoveButtons(),this.renderGutters()}renderGutters(){this.renderer.renderGutters(this.hintedRows,this.hintedCols,this.rowTotals,this.colTotals)}getUIState(){return{selected:this.selected,preview:this.preview,gameOver:this.gameOver,didWin:this.didWin,reviewMode:this.reviewMode,showAllBombs:this.showAllBombs,flagMode:this.flagMode,noteMode:this.noteMode}}onCellSelect(e){if(this.gameOver)return;const{r:t,c:s,button:n}=e;if(n===2){this.setStatus("Use Flag/Note buttons above.","hint");return}if(this.selected&&this.selected.r===t&&this.selected.c===s){this.selected=null,this.pickedDigit=null,this.noteBuffer="",this.clearPreview(),this.updateRemoveButtons(),this.renderer.highlightSelected(null),this.setStatus("Tile unselected.","hint");return}if(this.clearPreview(),this.selected={r:t,c:s},this.flagMode)if(this.board.entry[t][s])this.pickedDigit=this.board.entry[t][s];else if(this.board.flagNote[t][s])this.pickedDigit=this.board.flagNote[t][s];else if(this.board.noteText[t][s]){const a=this.board.noteText[t][s].match(/\d/);a?this.pickedDigit=parseInt(a[0]):this.pickedDigit=null}else this.pickedDigit=null;else this.noteMode?this.board.noteText[t][s]?this.noteBuffer=this.board.noteText[t][s]:this.board.entry[t][s]?this.noteBuffer=String(this.board.entry[t][s]):this.noteBuffer="":(this.pickedDigit=null,this.noteBuffer="");this.setPreviewForSelected(),this.updateRemoveButtons(),this.updateHintText(),this.renderer.highlightSelected(this.selected)}toggleFlagMode(){const e=this.flagMode;if(this.flagMode=!this.flagMode,this.flagMode&&(this.noteMode=!1),this.elements.flagBtn.classList.toggle("flagModeOn",this.flagMode),this.elements.markBtn.classList.remove("markModeOn"),this.setStatus(this.flagMode?"Flag mode ON.":"Flag mode OFF.","hint"),this.selected){const{r:t,c:s}=this.selected;if(this.flagMode&&!e){if(this.pickedDigit==null){if(this.noteBuffer){const n=this.noteBuffer.match(/\d/);n&&(this.pickedDigit=parseInt(n[0]))}else if(this.board.entry[t][s])this.pickedDigit=this.board.entry[t][s];else if(this.board.flagNote[t][s])this.pickedDigit=this.board.flagNote[t][s];else if(this.board.noteText[t][s]){const i=this.board.noteText[t][s].match(/\d/);i&&(this.pickedDigit=parseInt(i[0]))}}}else this.flagMode}this.noteBuffer="",this.setPreviewForSelected(),this.updateHintText(),this.buildNumpad()}toggleNoteMode(){const e=this.noteMode;if(this.noteMode=!this.noteMode,this.noteMode&&(this.flagMode=!1),this.elements.markBtn.classList.toggle("markModeOn",this.noteMode),this.elements.flagBtn.classList.remove("flagModeOn"),this.setStatus(this.noteMode?"Note mode ON.":"Note mode OFF.","hint"),this.selected){const{r:t,c:s}=this.selected;if(this.noteMode&&!e)this.noteBuffer||(this.pickedDigit!=null?this.noteBuffer=String(this.pickedDigit):this.board.noteText[t][s]?this.noteBuffer=this.board.noteText[t][s]:this.board.entry[t][s]&&(this.noteBuffer=String(this.board.entry[t][s])));else if(!this.noteMode&&e&&this.noteBuffer){const n=this.noteBuffer.match(/\d/);n&&(this.pickedDigit=parseInt(n[0]))}}this.noteMode?this.pickedDigit=null:this.noteBuffer="",this.setPreviewForSelected(),this.updateHintText(),this.buildNumpad()}toggleReview(){this.gameOver&&(this.reviewMode=!this.reviewMode,this.elements.reviewBtn.textContent=this.reviewMode?"â—¼ Exit Review":"ðŸ‘ Review Board",this.render())}buildNumpad(){this.elements.numpad.innerHTML="";for(let e=1;e<=9;e++){const t=document.createElement("button");t.textContent=e,t.classList.add("numBtn"),t.addEventListener("click",()=>this.onNumpadClick(e)),this.elements.numpad.appendChild(t)}if(this.noteMode){const e=document.createElement("button");e.textContent="/",e.style.fontWeight="900",e.addEventListener("click",()=>this.onSlashClick()),this.elements.numpad.appendChild(e)}}onNumpadClick(e){this.selected&&(this.noteMode?(this.noteBuffer.length&&!this.noteBuffer.endsWith("/")&&(this.noteBuffer+="/"),this.noteBuffer+=String(e)):this.pickedDigit=this.pickedDigit===e?null:e,this.setPreviewForSelected())}onSlashClick(){!this.selected||!this.noteMode||(this.noteBuffer.length&&!this.noteBuffer.endsWith("/")&&(this.noteBuffer+="/"),this.setPreviewForSelected())}onConfirm(){if(this.gameOver||!this.selected){this.setStatus("Select a tile first.","lose");return}const{r:e,c:t}=this.selected;if(this.board.given[e][t]){this.setStatus("This tile is a given.","lose"),this.renderer.bumpCell(e,t);return}this.noteMode?this.confirmNote(e,t):this.flagMode?this.confirmFlag(e,t):this.confirmNumber(e,t)}confirmNote(e,t){if(!this.noteBuffer){this.setStatus("Compose a note with digits and /.","lose"),this.renderer.bumpCell(e,t);return}this.board.entry[e][t]!=null&&(this.board.entry[e][t]=null,this.board.revealed[e][t]=!1),this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.flagsCount=Math.max(0,this.flagsCount-1),this.board.flagNote[e][t]=null),this.board.noteText[e][t]=this.noteBuffer,this.noteBuffer="",this.setStatus("Note placed.","hint"),this.clearPreview(),this.render(),this.updateStats()}confirmFlag(e,t){this.board.entry[e][t]!=null&&(this.board.entry[e][t]=null,this.board.revealed[e][t]=!1),this.board.noteText[e][t]&&(this.board.noteText[e][t]=""),this.board.flagged[e][t]||(this.board.flagged[e][t]=!0,this.flagsCount++),this.board.flagNote[e][t]=this.pickedDigit??null,this.setStatus(this.board.flagNote[e][t]==null?"Blank flag placed.":"Flag placed.","hint"),this.clearPreview(),this.render(),this.updateStats(),this.checkWin()&&this.endGame(!0,"All safe digits correct and bombs flagged!")}confirmNumber(e,t){if(this.board.bombs[e][t]){this.endGame(!1,"You touched a bomb.");return}if(this.pickedDigit==null){this.setStatus("Pick a number 1â€“9, then Confirm.","lose"),this.renderer.bumpCell(e,t);return}this.board.entry[e][t]=this.pickedDigit,this.board.revealed[e][t]=!0,this.board.noteText[e][t]&&(this.board.noteText[e][t]=""),this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.flagsCount=Math.max(0,this.flagsCount-1),this.board.flagNote[e][t]=null),this.setStatus("Digit placed.","hint"),this.clearPreview(),this.render(),this.checkWin()&&this.endGame(!0,"Perfect! All correct!")}removeFlag(){if(this.gameOver||!this.selected)return;const{r:e,c:t}=this.selected;this.board.flagged[e][t]&&(this.board.flagged[e][t]=!1,this.board.flagNote[e][t]=null,this.flagsCount=Math.max(0,this.flagsCount-1),this.pickedDigit=null,this.clearPreview(),this.render(),this.updateStats(),this.setStatus("Flag removed.","hint"),!this.gameOver&&this.checkWin()&&this.endGame(!0,"All correct!"))}removeMark(){if(this.gameOver||!this.selected)return;const{r:e,c:t}=this.selected;this.board.noteText[e][t]&&(this.board.noteText[e][t]="",this.noteBuffer="",this.clearPreview(),this.render(),this.setStatus("Note cleared.","hint"))}checkWin(){for(let e=0;e<l;e++)for(let t=0;t<l;t++)if(!this.board.bombs[e][t]&&(!this.board.revealed[e][t]||(this.board.entry[e][t]|0)!==this.board.solution[e][t]))return!1;for(let e=0;e<l;e++)for(let t=0;t<l;t++)if(this.board.bombs[e][t]&&(!this.board.flagged[e][t]||(this.board.flagNote[e][t]??null)!==this.board.solution[e][t]))return!1;return!0}endGame(e,t){this.gameOver=!0,this.didWin=!!e,e?(this.showAllBombs=!1,this.setStatus("You win! "+(t||""),"win"),this.elements.reviewBtn.style.display="none"):(this.showAllBombs=!0,this.setStatus("You lose! "+(t||""),"lose"),this.elements.reviewBtn.style.display="inline-block"),this.render()}clearPreview(){const t=this.preview&&this.preview.kind&&this.preview.r>=0&&this.preview.c>=0?{r:this.preview.r,c:this.preview.c}:null;this.preview={kind:null,value:null,r:-1,c:-1},t&&this.board&&this.renderer.renderCell(this.board,t.r,t.c,this.getUIState())}setPreviewForSelected(){if(!this.board||!this.selected||this.gameOver){this.clearPreview();return}const{r:e,c:t}=this.selected;if(this.board.revealed[e][t]&&this.board.given[e][t]){this.clearPreview();return}if(this.noteMode&&this.noteBuffer)this.preview={kind:"note",value:this.noteBuffer,r:e,c:t};else if(this.flagMode)this.preview={kind:"flag",value:this.pickedDigit??null,r:e,c:t};else if(!this.noteMode&&!this.flagMode&&this.pickedDigit!=null)this.preview={kind:"number",value:this.pickedDigit,r:e,c:t};else{this.clearPreview();return}this.renderer.renderCell(this.board,e,t,this.getUIState())}updateRemoveButtons(){if(!this.selected){this.elements.removeFlagBtn.disabled=!0,this.elements.removeMarkBtn.disabled=!0;return}const{r:e,c:t}=this.selected;this.elements.removeFlagBtn.disabled=!this.board.flagged[e][t],this.elements.removeMarkBtn.disabled=!this.board.noteText[e][t]}updateHintText(){this.flagMode?this.elements.asideHint.textContent="Flag mode: optionally add a digit to the flag; Confirm to commit.":this.noteMode?this.elements.asideHint.textContent="Note mode: tap digits and '/' to compose (e.g. 2/3); Confirm to place.":this.elements.asideHint.textContent="Number mode: pick a digit; Confirm to commit. Bombs lose instantly."}updateStats(){this.elements.bombsLeft.textContent="ðŸ’£ "+this.bombsTotal,this.elements.flagsCnt.textContent=String(this.flagsCount)}countCorrectFlags(){let e=0;for(let t=0;t<l;t++)for(let s=0;s<l;s++)this.board.bombs[t][s]&&this.board.flagged[t][s]&&e++;return e}setStatus(e,t){this.elements.status.className="status "+(t||""),this.elements.status.textContent=e}toggleTheme(){const t=(document.documentElement.getAttribute("data-theme")||"dark")==="light"?"dark":"light";this.applyTheme(t),ce(t)}applyTheme(e){const t=e==="light"?"light":"dark";document.documentElement.setAttribute("data-theme",t),this.elements.themeToggle.textContent=t==="light"?"ðŸŒ™":"â˜€ï¸"}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new ne):new ne;
